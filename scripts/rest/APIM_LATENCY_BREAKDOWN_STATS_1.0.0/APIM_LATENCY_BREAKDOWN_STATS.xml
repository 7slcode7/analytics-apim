<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>APIM_LATENCY_BREAKDOWN_STATS</Name>
<Script>
  create temporary table APIExecutionTimeData USING CarbonAnalytics OPTIONS(tableName "ORG_WSO2_APIMGT_STATISTICS_EXECUTION_TIME");
  CREATE TEMPORARY TABLE API_EXECUTION_TIME_SUMMARY_FINAL USING CarbonAnalytics OPTIONS (tableName "API_EXECUTION_TIME_SUMMARY",
  schema "api string -i,
  version string -i,
  apiPublisher string -i,
  context string -i,
  mediationName string -i,  
  executionTime long -i,  
  year int -i,
  month int -i,
  day int -i,
  hour int -i,
  minutes int -i,
  time long -i",
  primaryKeys "api,version,apiPublisher,context,year,month,day,hour,minutes,mediationName"
  );
   insert into table API_EXECUTION_TIME_SUMMARY_FINAL select api, api_version,apiPublisher,
  context,mediationName,avg(executionTime),
  substring(cast(first(eventTime)/1000 as timestamp),0,4),
  substring(cast(first(eventTime)/1000 as timestamp),6,2),
  substring(cast(first(eventTime)/1000 as timestamp),9,2),
  substring(cast(first(eventTime)/1000 as timestamp),12,2),
  (cast(cast(substring(cast(first(eventTime)/1000 as timestamp),15,2) as float)/5 as INT)*5),
  first(eventTime)
  from APIExecutionTimeData where api is not NULL group by api,api_version,apiPublisher,context,mediationName,
  substring(cast((eventTime)/1000 as timestamp),0,4),
  substring(cast((eventTime)/1000 as timestamp),6,2),
  substring(cast((eventTime)/1000 as timestamp),9,2),
  substring(cast((eventTime)/1000 as timestamp),12,2),
  (cast(cast(substring(cast(eventTime/1000 as timestamp),15,2) as float)/5 as INT)*5);  
  CREATE TEMPORARY TABLE API_EXECUTION_TIME_MINUTE_SUMMARY_FINAL USING CarbonAnalytics OPTIONS (tableName "API_EXECUTION_TIME_MINUTE_SUMMARY",
  schema "api string -i,
  version string -i,
  apiPublisher string -i,
  context string -i,
  mediationName string -i,  
  executionTime long -i,  
  year int -i,
  month int -i,
  day int -i,
  hour int -i,
  minutes int -i,
  seconds int -i,
  time long -i",
  primaryKeys "api,version,apiPublisher,context,year,month,day,hour,minutes,seconds,mediationName"
  );
   insert into table API_EXECUTION_TIME_MINUTE_SUMMARY_FINAL select api, api_version,apiPublisher,
  context,mediationName,avg(executionTime),
  substring(cast(first(eventTime)/1000 as timestamp),0,4),
  substring(cast(first(eventTime)/1000 as timestamp),6,2),
  substring(cast(first(eventTime)/1000 as timestamp),9,2),
  substring(cast(first(eventTime)/1000 as timestamp),12,2),
  substring(cast(first(eventTime)/1000 as timestamp),15,2),
  substring(cast(first(eventTime)/1000 as timestamp),18,2),
  first(eventTime)
  from APIExecutionTimeData where api is not NULL group by api,api_version,apiPublisher,context,mediationName,
  substring(cast((eventTime)/1000 as timestamp),0,4),
  substring(cast((eventTime)/1000 as timestamp),6,2),
  substring(cast((eventTime)/1000 as timestamp),9,2),
  substring(cast((eventTime)/1000 as timestamp),12,2),
  substring(cast((eventTime)/1000 as timestamp),15,2),
  substring(cast((eventTime)/1000 as timestamp),18,2);                       
</Script>
    <CronExpression>0 0/5 * 1/1 * ? *</CronExpression>
</Analytics>
